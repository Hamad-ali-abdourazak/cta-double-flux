<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Connexion - Supervision CTA</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light d-flex align-items-center justify-content-center" style="height:100vh;">
  <div class="card p-4 shadow" style="min-width:320px;max-width:350px;">
    <h4 class="mb-3 text-center">Connexion</h4>
    <div class="mb-2">
      <input id="login-user" class="form-control" placeholder="Utilisateur">
    </div>
    <div class="mb-3">
      <input id="login-pass" class="form-control" type="password" placeholder="Mot de passe">
    </div>
    <button id="btn-login" class="btn btn-primary w-100">Se connecter</button>
    <div id="login-error" class="alert alert-danger mt-3" style="display:none;"></div>
  </div>
  <script>
    function getUsers() {
      // Migration : fusionne anciens users (login) et nouveaux (username)
      const local = JSON.parse(localStorage.getItem('users') || '[]');
      // Ajoute les comptes par défaut si jamais aucun user n'existe
      if (!local.length) {
        return [
          {username: "admin", password: "admin", role: "admin"},
          {username: "operateur", password: "op", role: "operateur"},
          {username: "invite", password: "invite", role: "invite"}
        ];
      }
      return local;
    }
    document.getElementById('btn-login').onclick = function() {
      const login = document.getElementById('login-user').value;
      const pass = document.getElementById('login-pass').value;
      const users = getUsers();
      // Compatibilité : accepte login (ancien) ou username (nouveau)
      const user = users.find(u => (u.username === login || u.login === login) && u.password === pass);
      if (user) {
        // Pour compatibilité, stocke login et role
        localStorage.setItem('currentUser', JSON.stringify({
          login: user.username || user.login,
          role: user.role
        }));
        window.location.href = "index.html";
      } else {
        document.getElementById('login-error').textContent = "Identifiants invalides";
        document.getElementById('login-error').style.display = "block";
      }
    };
    // Si déjà connecté, redirige vers index
    if (localStorage.getItem('currentUser')) window.location.href = "index.html";
  </script>
</body>
</html>